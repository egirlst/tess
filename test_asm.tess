f! main {
    print:: "--- Tess Low-Level / ASM Test ---"
    
    # 1. Allocate Executable Memory (Grade 2 Feature)
    print:: "Allocating executable memory..."
    size = 1024
    mem_ptr = asm.alloc_exec(size)
    
    if mem_ptr == null {
        print:: "Failed to allocate executable memory!"
        return 1
    }
    print:: "Memory allocated at:", mem_ptr
    
    # 2. Write Machine Code (One-to-one mapping)
    # Target: x64 Return 123
    # Assembly:
    #   mov eax, 123
    #   ret
    
    # Mnemonics Helper (Grade 3 Abstraction over Grade 1)
    # Using 'mem' module (Grade 2) to write bytes
    
    offset = 0
    
    # MOV EAX, 123 (0x7B)
    # Opcode: B8 <le-32-bit-imm>
    mem.set(mem_ptr, offset, 184) # 0xB8
    offset = offset + 1
    mem.set(mem_ptr, offset, 123) # 0x7B
    offset = offset + 1
    mem.set(mem_ptr, offset, 0)
    offset = offset + 1
    mem.set(mem_ptr, offset, 0)
    offset = offset + 1
    mem.set(mem_ptr, offset, 0)
    offset = offset + 1
    
    # RET
    # Opcode: C3
    mem.set(mem_ptr, offset, 195) # 0xC3
    
    print:: "Machine code written."
    
    # 3. Execute (CPU Specific)
    print:: "Executing JIT code..."
    result = asm.exec(mem_ptr)
    
    print:: "Result (RAX/EAX):", result
    
    if result == 123 {
        print:: "SUCCESS: Code executed correctly!"
    } else {
        print:: "FAILURE: Unexpected result."
    }
    
    # 4. Console 5 sec kill (User Request)
    print:: "Waiting 5 seconds before exit..."
    sys.sleep(5000)
    
    print:: "Exiting now."
    sys.exit(0)
}

start >main<
